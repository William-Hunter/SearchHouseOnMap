<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>搜索房子</title>

    <script type="text/javascript"
            src="http://webapi.amap.com/maps?v=1.3&key=4722acf0a9640f220c55a71d05d79bb1"></script>
    <script src="http://cache.amap.com/lbs/static/jquery-1.9.1.js"></script>
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://cache.amap.com/lbs/static/jquery.range.js"></script>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>

    <style type="text/css">
        #container {
            width: 1225px;
            height: 585px;
        }

    </style>
</head>
<body>
<div id="container"></div>
<div id="tip">
    <span id="info"></span>
</div>

<div class="button-group">
    <input id='minprice' class="inputtext" type='text' placeholder='最低价'>
    <input id='maxprice' class="inputtext" type='text' placeholder='最高价'>
    <input id='radius' class="inputtext" type='text' placeholder='半径(KM)'>
    <input id="query" class="button" value="搜索" type="button"/>
</div>


<script type="text/javascript">

    var lat = '';
    var lon = '';

    var map = new AMap.Map('container', {
        resizeEnable: true,
        zoom: 14,
        center: [116.397428, 39.90923]
    });

    AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function () {
        var toolBar = new AMap.ToolBar();                   //工具条和比例尺
        var scale = new AMap.Scale();
        map.addControl(toolBar);
        map.addControl(scale);
    });

    map.on('moveend', getCity);
    function getCity() {
        map.getCity(function (data) {
            if (data['province'] && typeof data['province'] === 'string') {
                document.getElementById('info').innerHTML = '城市：' + (data['city'] || data['province']);
            }
        });
    }

    var marker;
    var markers=[];
    var circle;

    var icon = new AMap.Icon({
        image: './img/pointer.png',
        size: new AMap.Size(28, 28)
    });


    function clearMarkers(){
        if(markers){                                //如果多个点标记已经出现，就把他们都删除
            for(var i=0;i<markers.length;i++){
                markers[i].setMap(null);
            }
        }
    }

    function addmarkers(data) {
        for(var i=0;i<data.length;i++){
            var point=new AMap.Marker({
                map:map,
                position:[data[i].lon,data[i].lat],
                offset: new AMap.Pixel(-17, -42), //相对于基点的偏移位置
            });
            markers.push(point);
        }
        console.log("符合条件的公寓数："+i);
    }

    function clearCircle(){
         if(circle){                                 //清除圆
            circle.setMap(null);
        }
    }

    function addCircle(radius){
        circle = new AMap.Circle({                  //创建一个圆的效果
            center: [lon, lat],
            redius: radius,
            fillOpacity:0.1,
            fillColor:'#09f',
            strokeColor:'#09f',
            strokeWeight:1
        });
        circle.setMap(map);

    }

    function changeMarker() {
        clearMarkers();
        clearCircle();
        if (marker) {                               //如果已经点击过，就在地图上更新位置
            marker.setPosition([lon, lat]);
        } else {
            marker = new AMap.Marker({ //添加自定义点标记
                map: map,
                position: [lon, lat], //基点位置
                offset: new AMap.Pixel(-15, -25), //相对于基点的偏移位置 x+right-left,y+down-up
                icon:icon
            });
        }
        marker.setMap(map);
    }

    var clickEventListener = map.on('click', function (e) {                 //选取地点的点击函数
        lat = e.lnglat.getLat();
        lon = e.lnglat.getLng();
        clearMarkers();
        changeMarker();
    });



    AMap.event.addDomListener(document.getElementById('query'), 'click', function () {            //监听id为pantoBtn的元素的点击事件
        var minprice = document.getElementById('minprice').value;
        var maxprice = document.getElementById('maxprice').value;
        var radius = document.getElementById('radius').value;
        if (!minprice || !maxprice || !radius) {
            alert("请填写房子信息");
        } else if (!lon|!lat) {
            alert("请重新选取坐标");
        } else {
            clearMarkers();
            $.post("/Search?minprice=" + minprice + "&maxprice=" + maxprice + "&radius=" + radius + "&lon=" + lon+"&lat="+lat, function (data) {
                if(data){
                    addmarkers(data);
                    clearCircle();
                    addCircle(radius);
                }else{
                    alert("在此条件下没有结果");
                }
            });
        }
    });
    </script>


</body>
</html>